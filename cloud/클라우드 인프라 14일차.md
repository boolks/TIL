### 스웜을 이용한 실전 애플리케이션 개발 1

## MySQL 서비스 구축

데이터 스토어 역할을 수행할 MySQL 서비스를 마스터-슬레이브 구조로 구축

- MySQL 컨테이너는 도커 허브에 등록된 mysql:5.7 이미지를 기반으로 생성
- 마스터-슬레이브 컨테이너는 두 역할을 모두 수행할 수 있는 하나의 이미지로 생성
- 컨테이너에서 MYSQL_MASTER 환경변수의 값 유무에 따라 마스터-슬레이브 동작을 결정
- replicas 값을 조절해 슬레이브를 늘릴 수 있게 하며, 이때 마스터, 슬레이브 모두 일시 정지를 허용

#### 유틸리티 설치

```
vagrant@swarm-manager:~$ sudo apt install -y tree
vagrant@swarm-manager:~$ sudo apt install -y jq
```

#### #1 MySQL 이미지 생성을 위한 리포지토리 클론

```
vagrant@swarm-manager:~$ git clone https://github.com/gihyodocker/tododb

vagrant@swarm-manager:~$ tree ./tododb
./tododb
├── Dockerfile
├── LICENSE
├── README.md
├── add-server-id.sh
├── etc
│   └── mysql
│       ├── conf.d
│       │   └── mysql.cnf
│       └── mysql.conf.d
│           └── mysqld.cnf
├── init-data.sh
├── prepare.sh
└── sql
    ├── 01_ddl.sql
    └── 02_dml.sql

```

#### #2 MySQL 설정 확인

##### 2-1 mysqld.conf

```
vagrant@swarm-manager:~$ cat ~/tododb/etc/mysql/mysql.conf.d/mysqld.cnf
[mysqld]
character-set-server = utf8mb4
collation-server = utf8mb4_general_ci
pid-file        = /var/run/mysqld/mysqld.pid
socket          = /var/run/mysqld/mysqld.sock
datadir         = /var/lib/mysql
#log-error      = /var/log/mysql/error.log
# By default we only accept connections from localhost
#bind-address   = 127.0.0.1
# Disabling symbolic-links is recommended to prevent assorted security risks
symbolic-links=0
relay-log=mysqld-relay-bin
relay-log-index=mysqld-relay-bin

log-bin=/var/log/mysql/mysql-bin.log

replication을 위한 바이너리 로그 출력 경로, 마스터와 슬레이브 모두 동일하게 사용
```

##### 2-2 server-id 값을 추가하는 쉘 스크립트확인

```
vagrant@swarm-manager:~$ cat ~/tododb/add-server-id.sh
#!/bin/bash -e
OCTETS=(`hostname -i | tr -s '.' ' '`)

MYSQL_SERVER_ID=`expr ${OCTETS[2]} \* 256 + ${OCTETS[3]}`
echo "server-id=$MYSQL_SERVER_ID" >> /etc/mysql/mysql.conf.d/mysqld.cnf

컨테이너의 IP 주소에서 3, 4번째 옥텟 값을 뽑아 서버 간 중복되지 않는 server-id 값을 mysqld 파일에 추가
```

##### 2-3 replication 설정

```
vagrant@swarm-manager:~$ cat ~/tododb/add-server-id.sh
#!/bin/bash -e
OCTETS=(`hostname -i | tr -s '.' ' '`)

MYSQL_SERVER_ID=`expr ${OCTETS[2]} \* 256 + ${OCTETS[3]}`
echo "server-id=$MYSQL_SERVER_ID" >> /etc/mysql/mysql.conf.d/mysqld.cnf
vagrant@swarm-manager:~$ cat ~/tododb/prepare.sh
#!/bin/bash -e

# (1) MasterとSlaveを環境変数で制御する
if [ ! -z "$MYSQL_MASTER" ]; then
  echo "this container is master"
  exit 0
fi

echo "prepare as slave"

# (2) SlaveからMasterへの疎通確認をする
if [ -z "$MYSQL_MASTER_HOST" ]; then
  echo "mysql_master_host is not specified" 1>&2
  exit 1
fi

while :
do
  if mysql -h $MYSQL_MASTER_HOST -u root -p$MYSQL_ROOT_PASSWORD -e "quit" > /dev/null 2>&1 ; then
    echo "MySQL master is ready!"
    break
  else
    echo "MySQL master is not ready"
  fi
  sleep 3
done

# (3) Masterにレプリケーション用のユーザーと権限の作成
IP=`hostname -i`
IFS='.'
set -- $IP
SOURCE_IP="$1.$2.%.%"
mysql -h $MYSQL_MASTER_HOST -u root -p$MYSQL_ROOT_PASSWORD -e "CREATE USER IF NOT EXISTS '$MYSQL_REPL_USER'@'$SOURCE_IP' IDENTIFIED BY '$MYSQL_REPL_PASSWORD';"
mysql -h $MYSQL_MASTER_HOST -u root -p$MYSQL_ROOT_PASSWORD -e "GRANT REPLICATION SLAVE ON *.* TO '$MYSQL_REPL_USER'@'$SOURCE_IP';"

# (4) Masterのbinlogのポジションを取得
MASTER_STATUS_FILE=/tmp/master-status
mysql -h $MYSQL_MASTER_HOST -u root -p$MYSQL_ROOT_PASSWORD -e "SHOW MASTER STATUS\G" > $MASTER_STATUS_FILE
BINLOG_FILE=`cat $MASTER_STATUS_FILE | grep File | xargs | cut -d' ' -f2`
BINLOG_POSITION=`cat $MASTER_STATUS_FILE | grep Position | xargs | cut -d' ' -f2`
echo "BINLOG_FILE=$BINLOG_FILE"
echo "BINLOG_POSITION=$BINLOG_POSITION"

# (5) レプリケーションを開始する
mysql -u root -p$MYSQL_ROOT_PASSWORD -e "CHANGE MASTER TO MASTER_HOST='$MYSQL_MASTER_HOST', MASTER_USER='$MYSQL_REPL_USER', MASTER_PASSWORD='$MYSQL_REPL_PASSWORD', MASTER_LOG_FILE='$BINLOG_FILE', MASTER_LOG_POS=$BINLOG_POSITION;"
mysql -u root -p$MYSQL_ROOT_PASSWORD -e "START SLAVE;"

echo "slave started"
```

#### #3 이미지 생성 및 도커 허브 등록

##### 3-1 MySQL Dockerfile 정의

```
vagrant@swarm-manager:~$ cat ~/tododb/Dockerfile
FROM mysql:5.7

# (1) パッケージアップデートとwgetインストール
RUN apt-get update
RUN apt-get install -y wget

# (2) entrykitのインストール
RUN wget https://github.com/progrium/entrykit/releases/download/v0.4.0/entrykit_0.4.0_linux_x86_64.tgz
RUN tar -xvzf entrykit_0.4.0_linux_x86_64.tgz
RUN rm entrykit_0.4.0_linux_x86_64.tgz
RUN mv entrykit /usr/local/bin/
RUN entrykit --symlink

# (3) スクリプトと各種設定ファイルのコピー
COPY add-server-id.sh /usr/local/bin/
COPY etc/mysql/mysql.conf.d/mysqld.cnf /etc/mysql/mysql.conf.d/
COPY etc/mysql/conf.d/mysql.cnf /etc/mysql/conf.d/
COPY prepare.sh /docker-entrypoint-initdb.d
COPY init-data.sh /usr/local/bin/
COPY sql /sql

# (4) スクリプトとmysqldの実行
ENTRYPOINT [ \
  "prehook", \
    "add-server-id.sh", \
    "--", \
  "docker-entrypoint.sh" \
]

CMD ["mysqld"]
```

##### # 3-2 이미지 빌드

```
vagrant@swarm-manager:~$ cd ~/tododb
vagrant@swarm-manager:~/tododb$ docker image build -t boolks/tododb:latest .
```

##### 3-3 이미지 생성 확인 및 도커 허브 등록

```
vagrant@swarm-manager:~/tododb$ docker push boolks/tododb:latest
```

#### 4. MySQL 마스터 및 슬레이브 역할의 서비스 생성

```
vagrant@swarm-manager:~/tododb$ mkdir ~/stack && cd ~/stack
vagrant@swarm-manager:~/stack$ vi todo-mysql.yml

version: "3"

services:
  master:
    image: boolks/tododb:latest
    deploy:
      replicas: 1
      placement:
        constraints: [node.role != manager]
    environment:
      MYSQL_ROOT_PASSWORD: gihyo
      MYSQL_DATABASE: tododb
      MYSQL_USER: gihyo
      MYSQL_PASSWORD: gihyo
      MYSQL_MASTER: "true"
    networks:
      - todoapp
  slave:
    image: boolks/tododb:latest
    deploy:
      replicas: 2
      placement:
        constraints: [node.role != manager]
    depends_on:
      - master
    environment:
      MYSQL_MASTER_HOST: master
      MYSQL_ROOT_PASSWORD: gihyo
      MYSQL_DATABASE: tododb
      MYSQL_USER: gihyo
      MYSQL_PASSWORD: gihyo
      MYSQL_REPL_USER: repl
      MYSQL_REPL_PASSWORD: gihyo
    networks:
      - todoapp
networks:
  todoapp:
    external: true

```

#### 네트워크 확인

```
vagrant@swarm-manager:~/stack$ docker network ls
NETWORK ID          NAME                DRIVER              SCOPE
133354c52b37        bridge              bridge              local
213c4f7881f1        docker_gwbridge     bridge              local
019fafd359da        host                host                local
xgaw5s1h3ne0        ingress             overlay             swarm
bea5fa2ef2c2        none                null                local

```

#### todoapp 네트워크 추가

```
vagrant@swarm-manager:~/stack$ docker network create --driver=overlay todoapp
tjrh9ikywra2w2qlw0ezphn8d
vagrant@swarm-manager:~/stack$ docker network ls
NETWORK ID          NAME                DRIVER              SCOPE
133354c52b37        bridge              bridge              local
213c4f7881f1        docker_gwbridge     bridge              local
019fafd359da        host                host                local
xgaw5s1h3ne0        ingress             overlay             swarm
bea5fa2ef2c2        none                null                local
tjrh9ikywra2        todoapp             overlay             swarm
```

#### **기존 리소스(스택, 서비스, 컨테이너 등) 삭제**

```
$ docker stack rm $(docker stack ls -q)
$ docker service rm $(docker service ls -q)
$ docker container rm -f $(docker container ls -aq)
```

**todo_mysql 스택 생성**

```
vagrant@swarm-manager:~/stack$ docker stack deploy -c ./todo-mysql.yml todo_mysql
Creating service todo_mysql_master
Creating service todo_mysql_slave
vagrant@swarm-manager:~/stack$ docker stack ls
NAME                SERVICES            ORCHESTRATOR
todo_mysql          2                   Swarm
vagrant@swarm-manager:~/stack$ docker service ls
ID                  NAME                MODE                REPLICAS            IMAGE                  PORTS
kj3nf863m3x4        todo_mysql_master   replicated          1/1                 boolks/tododb:latest
b42zkw24g0io        todo_mysql_slave    replicated          2/2                 boolks/tododb:latest
vagrant@swarm-manager:~/stack$ docker service ps todo_mysql_master
ID                  NAME                  IMAGE                  NODE                DESIRED STATE       CURRENT STATE            ERROR               PORTS
pqmow0unxop7        todo_mysql_master.1   boolks/tododb:latest   swarm-worker2       Running             Running 41 seconds ago
vagrant@swarm-manager:~/stack$ docker service ps todo_mysql_slave
ID                  NAME                 IMAGE                  NODE                DESIRED STATE       CURRENT STATE            ERROR               PORTS
0toqb2uodlap        todo_mysql_slave.1   boolks/tododb:latest   swarm-worker1       Running             Running 43 seconds ago
n44msj90vt1a        todo_mysql_slave.2   boolks/tododb:latest   swarm-worker2       Running             Running 50 seconds ago
```

**mysql master (swarm-worker1)** **에서 init-data.sh 을 실행 ⇒ 테이블과 초기 데이터가 생성**

```
vagrant@swarm-worker1:~$ docker container ls
CONTAINER ID        IMAGE                  COMMAND                  CREATED              STATUS              PORTS                 NAMES
69797fcda78e        boolks/tododb:latest   "prehook add-server-…"   About a minute ago   Up About a minute   3306/tcp, 33060/tcp   todo_mysql_slave.1.0toqb2uodlapv6s8snnck2hqp
```

##### mysql master가 동작하는 컨테이너 내부에서 초기 테이블 및 데이터를 생성하는 스크립트를 실행

```
vagrant@swarm-worker1:~$ docker container exec -it 7d3de3c4e2bf init-data.sh
```

##### mysql master가 동작하는 컨테이너 내부에서 초기 테이블 및 데이터 생성을 확인

```
vagrant@swarm-worker1:~$ docker container exec -it 69797fcda78e mysql -u gihyo -pgihyo tododb
mysql: [Warning] Using a password on the command line interface can be insecure.
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 6
Server version: 5.7.31-log MySQL Community Server (GPL)

Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> select * from todo limit 1\G
*************************** 1. row ***************************
     id: 1
  title: MySQLのDockerイメージを作成する
content: MySQLのMaster、Slaveそれぞれで利用できるように、環境変数で役割を制御できるMySQLイメージを作成する
 status: DONE
created: 2020-09-28 08:44:40
updated: 2020-09-28 08:44:40
1 row in set (0.00 sec)

mysql> exit
Bye

```

**MySQL Slave(worker1, worker2)에 MySQL Master와 동일한 데이터가 생성되었는지 확인**

```
vagrant@swarm-worker1:~$ docker container ls
CONTAINER ID        IMAGE                  COMMAND                  CREATED             STATUS              PORTS                 NAMES
69797fcda78e        boolks/tododb:latest   "prehook add-server-…"   4 minutes ago       Up 4 minutes        3306/tcp, 33060/tcp   todo_mysql_slave.1.0toqb2uodlapv6s8snnck2hqp
vagrant@swarm-worker1:~$ docker container exec -it 69797fcda78e mysql -u gihyo -pgihyo tododb
mysql: [Warning] Using a password on the command line interface can be insecure.
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 7
Server version: 5.7.31-log MySQL Community Server (GPL)

Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> select * from todo limit 1\G
*************************** 1. row ***************************
     id: 1
  title: MySQLのDockerイメージを作成する
content: MySQLのMaster、Slaveそれぞれで利用できるように、環境変数で役割を制御できるMySQLイメージを作成する
 status: DONE
created: 2020-09-28 08:44:40
updated: 2020-09-28 08:44:40
1 row in set (0.00 sec)

mysql> exit
Bye
```

### API 서비스 구축

```
vagrant@swarm-manager:~$ git clone https://github.com/gihyodocker/todoapi
Cloning into 'todoapi'...
remote: Enumerating objects: 1, done.
remote: Counting objects: 100% (1/1), done.
remote: Total 36 (delta 0), reused 0 (delta 0), pack-reused 35
Unpacking objects: 100% (36/36), done.
vagrant@swarm-manager:~$ cd todoapi/
vagrant@swarm-manager:~/todoapi$ tree -a -I '.git|.gitignore' .
.
├── .dockerignore
├── Dockerfile
├── cmd
│   └── main.go
├── db.go
├── env.go
├── go.mod
├── go.sum
└── handler.go

1 directory, 8 files

```

### API 서비스 소스 코드 확인

#### main.go 소스 확인

```
vagrant@swarm-manager:~/todoapi$ cat ./cmd/main.go
package main

import (
        "fmt"
        "log"
        "net/http"
        "os"

        "github.com/gihyodocker/todoapi"
)

func main() {

        // (1) 必要な環境変数を格納した構造体を作成
        env, err := todoapi.CreateEnv()
        if err != nil {
                fmt.Fprint(os.Stderr, err.Error())
                os.Exit(1)
        }

        // (2) MySQL Masterへの接続するための構造体を作成
        masterDB, err := todoapi.CreateDbMap(env.MasterURL)
        if err != nil {
                fmt.Fprintf(os.Stderr, "%s is invalid database", env.MasterURL)
                return
        }

        // (3) MySQL Slaveへの接続するための構造体を作成
        slaveDB, err := todoapi.CreateDbMap(env.SlaveURL)
        if err != nil {
                fmt.Fprintf(os.Stderr, "%s is invalid database", env.SlaveURL)
                return
        }

        mux := http.NewServeMux()

        // (4) ヘルスチェック用APIのハンドラを作成
        hc := func(w http.ResponseWriter, r *http.Request) {
                log.Println("[GET] /hc")
                w.Write([]byte("OK"))
        }

        // (5) TODO操作APIのハンドラを作成
        todoHandler := todoapi.NewTodoHandler(masterDB, slaveDB)

        // (6) ハンドラをAPIエンドポイントとして登録
        mux.Handle("/todo", todoHandler)
        mux.HandleFunc("/hc", hc)

        // (7) サーバのポートやハンドラを設定し、Listenを開始
        s := http.Server{
                Addr:    env.Bind,
                Handler: mux,
        }
        log.Printf("Listen HTTP Server")
        if err := s.ListenAndServe(); err != nil {
                log.Fatal(err)
        }
}
```

#### 환경변수 값을 가져와서 구조체에 저장하는 소스 확인

```
vagrant@swarm-manager:~/todoapi$ cat ./env.go
package todoapi

import (
        "errors"
        "os"
)

// 必要な環境変数を格納するための構造体
type Env struct {
        Bind      string
        MasterURL string
        SlaveURL  string
}

func CreateEnv() (*Env, error) {

        env := Env{}

        bind := os.Getenv("TODO_BIND") // APIをListenするポート設定
        if bind == "" {
                env.Bind = ":8080"
        }
        env.Bind = bind

        masterURL := os.Getenv("TODO_MASTER_URL") // MySQL Masterへの接続情報
        if masterURL == "" {
                return nil, errors.New("TODO_MASTER_URL is not specified")
        }
        env.MasterURL = masterURL

        slaveURL := os.Getenv("TODO_SLAVE_URL") // MySQL Slaveへの接続情報
        if slaveURL == "" {
                return nil, errors.New("TODO_SLAVE_URL is not specified")
        }
        env.SlaveURL = slaveURL

        return &env, nil
}

```

#### MySQL 접속을 위한 소스 확인

```
vagrant@swarm-manager:~/todoapi$ cat ./db.go
package todoapi

import (
        "database/sql"
        "time"

        _ "github.com/go-sql-driver/mysql"
        gorp "gopkg.in/gorp.v1"
)

func CreateDbMap(dbURL string) (*gorp.DbMap, error) {

        ds, err := createDatasource(dbURL)
        if err != nil {
                return nil, err
        }

        db := &gorp.DbMap{
                Db: ds,
                Dialect: gorp.MySQLDialect{
                        Engine:   "InnoDB",
                        Encoding: "utf8mb4",
                },
        }

        db.AddTableWithName(Todo{}, "todo").SetKeys(true, "ID")
        return db, nil
}

func createDatasource(dbURL string) (*sql.DB, error) {

        db, err := sql.Open("mysql", dbURL)
        if err != nil {
                return nil, err
        }

        db.SetMaxIdleConns(2)
        return db, nil
}

type Todo struct {
        ID      uint      `db:"id"      json:"id"`
        Title   string    `db:"title"   json:"title"`
        Content string    `db:"content" json:"content"`
        Status  string    `db:"status"  json:"status"`
        Created time.Time `db:"created" json:"created"`
        Updated time.Time `db:"updated" json:"updated"`
}
```

#### HTTP 요청을 처리하는 핸들러 소스 확인

```
vagrant@swarm-manager:~/todoapi$ cat ./handler.go
package todoapi

import (
        "database/sql"
        "encoding/json"
        "fmt"
        "io/ioutil"
        "log"
        "net/http"
        "time"

        gorp "gopkg.in/gorp.v1"
)

// Handlerの中でDBへクエリを発行するため、DB接続の構造体を持つ
type TodoHandler struct {
        master *gorp.DbMap
        slave  *gorp.DbMap
}

// Handlerの作成関数
func NewTodoHandler(master *gorp.DbMap, slave *gorp.DbMap) http.Handler {
        return &TodoHandler{
                master: master,
                slave:  slave,
        }
}

// HTTPリクエストを受け、ビジネスロジックを実行してレスポンスを返す
func (h TodoHandler) ServeHTTP(w http.ResponseWriter, r *http.Request) {

        log.Printf("[%s] RemoteAddr=%s\tUserAgent=%s", r.Method, r.RemoteAddr, r.Header.Get("User-Agent"))
        switch r.Method {
        case "GET":
                h.serveGET(w, r)
                return
        case "POST":
                h.servePOST(w, r)
                return
        case "PUT":
                h.servePUT(w, r)
                return
        default:
                NewErrorResponse(http.StatusMethodNotAllowed, fmt.Sprintf("%s is Unsupported method", r.Method)).Write(w)
                return
        }
}

type errorResponse struct {
        Status  int    `json:"status"`
        Message string `json:"message"`
}

func NewErrorResponse(status int, message string) *errorResponse {
        return &errorResponse{
                Status:  status,
                Message: message,
        }
}

func (e *errorResponse) Write(w http.ResponseWriter) {
        data, err := json.Marshal(e)
        if err != nil {
                log.Println("marshal error json is failed")
        }

        w.Header().Set("Content-Type", "application/json; charset=utf-8")
        w.WriteHeader(e.Status)
        w.Write(data)
}

func (h TodoHandler) serveGET(w http.ResponseWriter, r *http.Request) {

        status := r.URL.Query().Get("status")
        if status == "" {
                status = "TODO"
        }

        result, err := h.slave.Select(Todo{}, "SELECT * FROM todo WHERE status = ? ORDER BY updated DESC", status)
        if err != nil {
                log.Println(err.Error())
                NewErrorResponse(http.StatusInternalServerError, "Execute Query is failed").Write(w)
                return
        }

        todoItems := make([]*Todo, 0)

        for _, e := range result {
                todo := e.(*Todo)
                todoItems = append(todoItems, todo)
        }

        data, err := json.Marshal(todoItems)
        if err != nil {
                log.Println(err.Error())
                NewErrorResponse(http.StatusInternalServerError, "Marshal JSON is failed").Write(w)
                return
        }

        w.Header().Set("Content-Type", "application/json; charset=utf-8")
        w.Write(data)
}

type TodoPostPayload struct {
        Title   string `json:"title"`
        Content string `json:"content"`
}

func (h TodoHandler) servePOST(w http.ResponseWriter, r *http.Request) {

        raw, err := ioutil.ReadAll(r.Body)
        if err != nil {
                log.Println(err.Error())
                NewErrorResponse(http.StatusInternalServerError, "Read payload is failed").Write(w)
                return
        }

        var payload TodoPostPayload
        if err := json.Unmarshal(raw, &payload); err != nil {
                log.Println(err.Error())
                NewErrorResponse(http.StatusInternalServerError, "Parse payload is failed").Write(w)
                return
        }

        now := time.Now()
        todo := Todo{
                Title:   payload.Title,
                Content: payload.Content,
                Status:  "TODO",
                Created: now,
                Updated: now,
        }

        if err := h.master.Insert(&todo); err != nil {
                log.Println(err.Error())
                NewErrorResponse(http.StatusInternalServerError, "Insert Data is failed").Write(w)
                return
        }

        w.Header().Set("Content-Type", "application/json; charset=utf-8")
        w.WriteHeader(http.StatusCreated)
}

type TodoPutPayload struct {
        ID      uint   `json:"id"`
        Title   string `json:"title"`
        Content string `json:"content"`
        Status  string `json:"status"`
}

func (h TodoHandler) servePUT(w http.ResponseWriter, r *http.Request) {

        raw, err := ioutil.ReadAll(r.Body)
        if err != nil {
                log.Println(err.Error())
                NewErrorResponse(http.StatusInternalServerError, "Read payload is failed").Write(w)
                return
        }

        var payload TodoPutPayload
        if err := json.Unmarshal(raw, &payload); err != nil {
                log.Println(err.Error())
                NewErrorResponse(http.StatusInternalServerError, "Parse payload is failed").Write(w)
                return
        }

        var target Todo
        if err := h.slave.SelectOne(&target, "SELECT * FROM todo WHERE id = ?", payload.ID); err != nil {
                if err == sql.ErrNoRows {
                        NewErrorResponse(http.StatusNotFound, fmt.Sprintf("id=%d is not found", payload.ID)).Write(w)
                } else {
                        log.Println(err.Error())
                        NewErrorResponse(http.StatusInternalServerError, "Select todo is failed").Write(w)
                }
                return
        }

        now := time.Now()
        todo := Todo{
                ID:      payload.ID,
                Title:   payload.Title,
                Content: payload.Content,
                Status:  payload.Status,
                Created: target.Created,
                Updated: now,
        }

        if _, err := h.master.Update(&todo); err != nil {
                log.Println(err.Error())
                NewErrorResponse(http.StatusInternalServerError, "Update Data is failed").Write(w)
                return
        }

        w.Header().Set("Content-Type", "application/json")
        w.WriteHeader(http.StatusOK)
}
```

### 이미지 생성 및 도커 허브 등록

#### Dockerfile 작성

```
vagrant@swarm-manager:~/todoapi$ cat Dockerfile
FROM golang:1.13

WORKDIR /
ENV GOPATH /go

COPY . /go/src/github.com/gihyodocker/todoapi
RUN go get github.com/go-sql-driver/mysql
RUN go get gopkg.in/gorp.v1
RUN cd /go/src/github.com/gihyodocker/todoapi && go build -o bin/todoapi cmd/main.go
RUN cd /go/src/github.com/gihyodocker/todoapi && cp bin/todoapi /usr/local/bin/

CMD ["todoapi"]
```

#### 이미지 빌드

```
vagrant@swarm-manager:~/todoapi$ docker image build -t boolks/todoapi:latest .

```

#### 이미지 생성 확인 및 도커 허브 등록

```
vagrant@swarm-manager:~/todoapi$ docker image ls
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
boolks/todoapi      latest              e51c2a456454        16 seconds ago      829MB

vagrant@swarm-manager:~/todoapi$ docker push boolks/todoapi
```

### todo_api 서비스 실행

```
vagrant@swarm-manager:~/todoapi$ cd ~/stack/
vagrant@swarm-manager:~/stack$ vi todo-app.yml

version: "3"
services:
  api:
    image: myanjini/todoapi:latest
    deploy:
      replicas: 2
      placement:
        constraints: [node.role != manager]
    environment:
      TODO_BIND: ":8080"
      TODO_MASTER_URL: "gihyo:gihyo@tcp(todo_mysql_master:3306)/tododb?parseTime=true"
      TODO_SLAVE_URL: "gihyo:gihyo@tcp(todo_mysql_slave:3306)/tododb?parseTime=true"
    networks:
      - todoapp

networks:
  todoapp:
    external: true
    
vagrant@swarm-manager:~/stack$ docker stack deploy -c ./todo-app.yml todo_app
vagrant@swarm-manager:~/stack$ docker service ls
ID                  NAME                MODE                REPLICAS            IMAGE                     PORTS
n0k2eew4vlsf        todo_app_api        replicated          0/2                 myanjini/todoapi:latest
kj3nf863m3x4        todo_mysql_master   replicated          1/1                 boolks/tododb:latest
b42zkw24g0io        todo_mysql_slave    replicated          2/2                 boolks/tododb:latest

```

#### 서비스의 상태(CURRENT STATE)를 통해 정상 실행 여부를 확인

```
vagrant@swarm-manager:~/stack$ docker service ps todo_app_api
ID                  NAME                IMAGE                     NODE                DESIRED STATE       CURRENT STATE           ERROR               PORTS
4v3v0mgcfd9r        todo_app_api.1      myanjini/todoapi:latest   swarm-worker1       Running             Running 4 seconds ago
kcp5yz2e2ki0        todo_app_api.2      myanjini/todoapi:latest   swarm-worker1       Running             Running 4 seconds ago
```

#### API 서버 로그를 통해 정상 실행 여부 확인

```
vagrant@swarm-manager:~/stack$ cat ../todoapi/cmd/main.go
package main

import (
        "fmt"
        "log"
        "net/http"
        "os"

        "github.com/gihyodocker/todoapi"
)

func main() {

        // (1) 必要な環境変数を格納した構造体を作成
        env, err := todoapi.CreateEnv()
        if err != nil {
                fmt.Fprint(os.Stderr, err.Error())
                os.Exit(1)
        }

        // (2) MySQL Masterへの接続するための構造体を作成
        masterDB, err := todoapi.CreateDbMap(env.MasterURL)
        if err != nil {
                fmt.Fprintf(os.Stderr, "%s is invalid database", env.MasterURL)
                return
        }

        // (3) MySQL Slaveへの接続するための構造体を作成
        slaveDB, err := todoapi.CreateDbMap(env.SlaveURL)
        if err != nil {
                fmt.Fprintf(os.Stderr, "%s is invalid database", env.SlaveURL)
                return
        }

        mux := http.NewServeMux()

        // (4) ヘルスチェック用APIのハンドラを作成
        hc := func(w http.ResponseWriter, r *http.Request) {
                log.Println("[GET] /hc")
                w.Write([]byte("OK"))
        }

        // (5) TODO操作APIのハンドラを作成
        todoHandler := todoapi.NewTodoHandler(masterDB, slaveDB)

        // (6) ハンドラをAPIエンドポイントとして登録
        mux.Handle("/todo", todoHandler)
        mux.HandleFunc("/hc", hc)

        // (7) サーバのポートやハンドラを設定し、Listenを開始
        s := http.Server{
                Addr:    env.Bind,
                Handler: mux,
        }
        log.Printf("Listen HTTP Server")	<= API 서버가 정상 실행되면 해당 메세지 출력
        if err := s.ListenAndServe(); err != nil {
                log.Fatal(err)
        }
}

vagrant@swarm-manager:~/stack$ docker service logs -f todo_app_api
todo_app_api.1.4v3v0mgcfd9r@swarm-worker1    | 2020/09/28 05:58:15 Listen HTTP Server
todo_app_api.2.kcp5yz2e2ki0@swarm-worker1    | 2020/09/28 05:58:15 Listen HTTP Server
```

#### API 서버의 서비스가 정상 동작하는지 확인

```
vagrant@swarm-worker1:~$ docker container ls
CONTAINER ID        IMAGE                     COMMAND                  CREATED             STATUS              PORTS                 NAMES
d857e6091c01        myanjini/todoapi:latest   "todoapi"                13 seconds ago      Up 7 seconds                              todo_app_api.1.ulyrvhy6ps0q129tatc8tufl5
6

vagrant@swarm-worker1:~$ docker container exec d857e6091c01 curl http://localhost:8080/todo?status=TODO
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   216  100   216    0     0   2097      0 --:--:-- --:--:-- --:--:--  2117
[{"id":8,"title":"Ingressを構築する","content":"Swarmクラスタに外からアクセスするためのIngressを構築する","status":"TODO","created":"2020-09-28T08:44:40Z","updated":"2020-09-28T08:44:40Z"}]
```

#### 출력결과를 JSON 형식으로 보여주는 jq 프로그램을 컨테이너 내부에 설치

```
vagrant@swarm-worker1:~$ docker container exec -it 44e2ce2c4a27 /bin/bash
root@44e2ce2c4a27:/# apt update
root@44e2ce2c4a27:/# apt install -y jq
root@d857e6091c01:/# curl http://localhost:8080/todo?status=TODO | jq
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   216  100   216    0     0  36000      0 --:--:-- --:--:-- --:--:-- 36000
[
  {
    "id": 8,
    "title": "Ingressを構築する",
    "content": "Swarmクラスタに外からアクセスするためのIngressを構築する",
    "status": "TODO",
    "created": "2020-09-28T08:44:40Z",
    "updated": "2020-09-28T08:44:40Z"
  }
]

```

#### 서비스 이름으로 요청도 가능

```
root@44e2ce2c4a27:/# curl http://todo_app_api:8080/todo?status=TODO
[{"id":8,"title":"Ingressを構築する","content":"Swarmクラスタに外からアクセスするためのIngressを構築する","status":"TODO","created":"2020-09-28T02:30:24Z","updated":"2020-09-28T02:30:24Z"}]


vagrant@swarm-worker1:~$ docker container exec 44e2ce2c4a27 curl http://todo_app_api:8080/todo?status=TODO
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   216  100   216    0     0  21600      0 --:--:-- --:--:-- --:--:-- 21600
[{"id":8,"title":"Ingressを構築する","content":"Swarmクラスタに外からアクセスするためのIngressを構築する","status":"TODO","created":"2020-09-28T02:30:24Z","updated":"2020-09-28T02:30:24Z"}]
```

##### 포트포워딩 설정을 추가해서 컨테이너 외부에서 접속

```
vagrant@swarm-manager:~/stack$ vi todo-app.yml
version: "3"
services:
  api:
    image: boolks/todoapi:latest
    deploy:
      replicas: 2
      placement:
        constraints: [node.role != manager]
    environment:
      TODO_BIND: ":8080"
      TODO_MASTER_URL: "gihyo:gihyo@tcp(todo_mysql_master:3306)/tododb?parseTime=true"
      TODO_SLAVE_URL: "gihyo:gihyo@tcp(todo_mysql_slave:3306)/tododb?parseTime=true"
    networks:
      - todoapp
    ports:
      - "8080:8080"

networks:
  todoapp:
    external: true
```

```
vagrant@swarm-manager:~/stack$ docker stack rm todo_app
Removing service todo_app_api


vagrant@swarm-manager:~/stack$ docker stack deploy -c ./todo-app.yml todo_app
Creating service todo_app_api


vagrant@swarm-manager:~/stack$ docker service ls
ID                  NAME                MODE                REPLICAS            IMAGE                   PORTS
sauiwk0wurru        todo_app_api        replicated          2/2                 boolks/todoapi:latest   *:8080->8080/tcp
kj3nf863m3x4        todo_mysql_master   replicated          1/1                 boolks/tododb:latest
b42zkw24g0io        todo_mysql_slave    replicated          2/2                 boolks/tododb:latest


vagrant@swarm-manager:~/stack$ curl http://localhost:8080/todo?status=TODO | jq
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   216  100   216    0     0   5538      0 --:--:-- --:--:-- --:--:--  5538
[
  {
    "id": 8,
    "title": "Ingressを構築する",
    "content": "Swarmクラスタに外からアクセスするためのIngressを構築する",
    "status": "TODO",
    "created": "2020-09-28T08:44:40Z",
    "updated": "2020-09-28T08:44:40Z"
  }
]
```

##### 포트 포워딩 부분을 원상복구

```
vagrant@swarm-manager:~/stack$ vi todo-app.yml
ports 항목을 삭제 후 저장

vagrant@swarm-manager:~/stack$ docker stack deploy -c ./todo-app.yml todo_app
Updating service todo_app_api (id: k6o518xv0jc1m0x25fzybbvzb)
```



### **API 서버 앞에 nginx 서버를 위치**

```
vagrant@swarm-manager:~/stack$ cd

vagrant@swarm-manager:~$ git clone https://github.com/gihyodocker/todonginx

vagrant@swarm-manager:~/todonginx$ tree .
.
├── Dockerfile
└── etc
    └── nginx
        ├── conf.d
        │   ├── log.conf
        │   ├── public.conf.tmpl		⇐ entrykit에서 제공하는 템플릿 기능을 적용한 파일
        │   └── upstream.conf.tmpl
        └── nginx.conf.tmpl

3 directories, 5 files


vagrant@swarm-manager:~/todonginx$ docker image build -t boolks/nginx:latest .

vagrant@swarm-manager:~/todonginx$ docker image ls
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
boolks/nginx        latest              2423c3857b86        11 seconds ago      156MB


vagrant@swarm-manager:~/todonginx$ docker image push boolks/nginx:latest


vagrant@swarm-manager:~/todonginx$ cd ~/stack
vagrant@swarm-manager:~/stack$ vi todo-app.yml

version: "3"
services:
  api:
    image: boolks/todoapi:latest
    deploy:
      replicas: 2
      placement:
        constraints: [node.role != manager]
    environment:
      TODO_BIND: ":8080"
      TODO_MASTER_URL: "gihyo:gihyo@tcp(todo_mysql_master:3306)/tododb?parseTime=true"
      TODO_SLAVE_URL: "gihyo:gihyo@tcp(todo_mysql_slave:3306)/tododb?parseTime=true"
    networks:
      - todoapp
  nginx:
    image: boolks/nginx:latest
    deploy:
      replicas: 2
      placement:
        constraints: [node.role != manager]
    depends_on:
      - api
    environment:
      WORKER_PROCESSES: 2
      WORKER_CONNECTIONS: 1024
      KEEPALIVE_TIMEOUT: 65
      GZIP: "on"
      BACKEND_HOST: todo_app_api:8080
      BACKEND_MAX_FAILES: 3
      BACKEND_FAIL_TIMEOUT: 10s
      SERVER_PORT: 80
      SERVER_NAME: todo_app_nginx
      LOG_STDOUT: "true"
    networks:
      - todoapp
networks:
  todoapp:
    external: true

vagrant@swarm-manager:~/stack$ docker stack deploy -c ./todo-app.yml todo_app
Updating service todo_app_api (id: sauiwk0wurrumahm09r1pfqdm)
Creating service todo_app_nginx

vagrant@swarm-manager:~/stack$ docker service ls
ID                  NAME                MODE                REPLICAS            IMAGE                   PORTS
sauiwk0wurru        todo_app_api        replicated          2/2                 boolks/todoapi:latest

vagrant@swarm-manager:~/stack$ docker service ps todo_app_nginx
ID                  NAME                   IMAGE                   NODE                DESIRED STATE       CURRENT STATE               ERROR                       PORTS
kve8ayn8e3ok        todo_app_nginx.1       boolks/nginx:latest     swarm-worker1       Running             Running 7 seconds ago                                
```

### nginx를 통해서 API 서비스 요청을 테스트

```
vagrant@swarm-worker1:~$ docker container ls
CONTAINER ID        IMAGE                   COMMAND                  CREATED             STATUS              PORTS                 NAMES
877fad36ec11        boolks/nginx:latest     "render /etc/nginx/n…"   43 seconds ago      Up 40 seconds       80/tcp                todo_app_nginx.1.kve8ayn8e3okdxcdhhjcwyg9t
df8db412549a        boolks/todoapi:latest   "todoapi"                58 seconds ago      Up 51 seconds                             todo_app_api.1.z1l8upw76exm1mfbjstjv3ztc
69797fcda78e        boolks/tododb:latest    "prehook add-server-…"   27 minutes ago      Up 27 minutes       3306/tcp, 33060/tcp   todo_mysql_slave.1.0toqb2uodlapv6s8snnck2hqp
vagrant@swarm-wor

### nginx가 구동되고 있는 컨테이너 내부에 curl, jq를 먼저 설치
vagrant@swarm-worker1:~$ docker container exec 877fad36ec11 apt install -y curl
vagrant@swarm-worker1:~$ docker container exec 877fad36ec11 apt install -y jq

vagrant@swarm-worker1:~$ docker container exec 877fad36ec11 curl http://localhost/todo?status=TODO
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   216  100   216    0     0   3236      0 --:--:-- --:--:-- --:--:--  3272
[{"id":8,"title":"Ingressを構築する","content":"Swarmクラスタに外からアクセスするためのIngressを構築する","status":"TODO","created":"2020-09-28T08:44:40Z","updated":"2020-09-28T08:44:40Z"}]
```

### **프론트엔드 웹 서비스 구축**

https://myanjini.tistory.com/entry/%EC%8A%A4%EC%9B%9C%EC%9D%84-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EC%8B%A4%EC%A0%84-%EC%95%A0%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98-%EA%B0%9C%EB%B0%9C-4

```
vagrant@swarm-manager:~/stack$ cd

vagrant@swarm-manager:~$ git clone https://github.com/gihyodocker/todoweb

vagrant@swarm-manager:~$ cd todoweb
vagrant@swarm-manager:~/todoweb$ tree .
.
├── Dockerfile
├── README.md
├── assets
│   ├── README.md
│   └── style
│       └── app.styl
├── layouts
│   ├── README.md
│   └── default.vue
├── middleware
│   └── README.md
├── nuxt.config.js
├── package-lock.json
├── package.json
├── pages
│   ├── README.md
│   └── index.vue
├── plugins
│   ├── README.md
│   └── vuetify.js
├── server.js
├── static
│   ├── README.md
│   ├── favicon.ico
│   └── v.png
└── store
    └── README.md

vagrant@swarm-manager:~/todoweb$ docker image build -t boolks/todoweb:latest .

vagrant@swarm-manager:~/todoweb$ docker image ls
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
boolks/todoweb      latest              4a497aa82a24        7 seconds ago       855MB
boolks/nginx        latest              2423c3857b86        8 minutes ago       156MB
boolks/todoapi      latest              16c8340feeab        20 minutes ago      829MB
boolks/tododb       latest              687665459d7a        4 hours ago         491MB

vagrant@swarm-manager:~/todoweb$ docker image push boolks/todoweb:latest
```

### 정적자원(예:이미지)을 nginx가 바로 제공하도록 설정을 변경

```
vagrant@swarm-manager:~/todoweb$ cd ../todonginx/
vagrant@swarm-manager:~/todonginx$ cp ./etc/nginx/conf.d/public.conf.tmpl ./etc/nginx/conf.d/nuxt.conf.tmpl
vagrant@swarm-manager:~/todonginx$ vi ./etc/nginx/conf.d/nuxt.conf.tmpl

server {
    listen {{ var "SERVER_PORT" | default "80" }} default_server;
    server_name {{ var "SERVER_NAME" | default "localhost" }};
    charset utf-8;

    location /_nuxt/ {
        alias /var/www/_nuxt/$1;
        {{ if var "LOG_STDOUT" }}
        access_log  /dev/stdout json;
        error_log   /dev/stderr;
        {{ else }}
        access_log  /var/log/nginx/backend_access.log json;
        error_log   /var/log/nginx/backend_error.log;
        {{ end }}
    }
    location / {
        proxy_pass http://backend;
        proxy_pass_request_headers on;
        proxy_set_header host $host;
        {{ if var "LOG_STDOUT" }}
        access_log  /dev/stdout json;
        error_log   /dev/stderr;
        {{ else }}
        access_log  /var/log/nginx/backend_access.log json;
        error_log   /var/log/nginx/backend_error.log;
        {{ end }}
        {{ if var "BASIC_AUTH_FILE" }}
        auth_basic "Restricted";
        auth_basic_user_file {{ var "BASIC_AUTH_FILE" }};
        {{ end }}
    }
}

```

##### 정적자원을 nginx가 바로 제공하도록 설정 변경

```
vagrant@swarm-manager:~/todoweb$ cd ../todonginx/
vagrant@swarm-manager:~/todonginx$ cp ./etc/nginx/conf.d/public.conf.tmpl ./etc/nginx/conf.d/nuxt.conf.tmpl
vagrant@swarm-manager:~/todonginx$ vi ./etc/nginx/conf.d/nuxt.conf.tmpl

    listen {{ var "SERVER_PORT" | default "80" }} default_server;
    server_name {{ var "SERVER_NAME" | default "localhost" }};
    charset utf-8;

    location /_nuxt/ {
        alias /var/www/_nuxt/$1;
        {{ if var "LOG_STDOUT" }}
        access_log  /dev/stdout json;
        error_log   /dev/stderr;
        {{ else }}
        access_log  /var/log/nginx/backend_access.log json;
        error_log   /var/log/nginx/backend_error.log;
        {{ end }}
    }
    location / {
        proxy_pass http://backend;
        proxy_pass_request_headers on;
        proxy_set_header host $host;
        {{ if var "LOG_STDOUT" }}
        access_log  /dev/stdout json;
        error_log   /dev/stderr;
        {{ else }}
        access_log  /var/log/nginx/backend_access.log json;
        error_log   /var/log/nginx/backend_error.log;
        {{ end }}
        {{ if var "BASIC_AUTH_FILE" }}
        auth_basic "Restricted";
        auth_basic_user_file {{ var "BASIC_AUTH_FILE" }};
        {{ end }}
    }
}
```



##### Dockerfile 수정 (정적 파일을 nginx가 처리하도록 수정)

```
vagrant@swarm-manager:~/todonginx$ cp ./Dockerfile ./Dockerfile-nuxt
vagrant@swarm-manager:~/todonginx$ vi ./Dockerfile-nuxt
FROM nginx:1.13

RUN apt-get update
RUN apt-get install -y wget
RUN wget https://github.com/progrium/entrykit/releases/download/v0.4.0/entrykit_0.4.0_linux_x86_64.tgz
RUN tar -xvzf entrykit_0.4.0_linux_x86_64.tgz
RUN rm entrykit_0.4.0_linux_x86_64.tgz
RUN mv entrykit /usr/local/bin/
RUN entrykit --symlink

RUN rm /etc/nginx/conf.d/*
COPY etc/nginx/nginx.conf.tmpl /etc/nginx/
COPY etc/nginx/conf.d/ /etc/nginx/conf.d/

ENTRYPOINT [ \
  "render", \
      "/etc/nginx/nginx.conf", \
      "--", \
  "render", \
      "/etc/nginx/conf.d/upstream.conf", \
      "--", \
  "render", \
      "/etc/nginx/conf.d/nuxt.conf", \		<= 변경
      "--" \
]

CMD ["nginx", "-g", "daemon off;"]

```

##### 빌드

```
vagrant@swarm-manager:~/todonginx$ docker image build -t boolks/nginx-nuxt:latest -f Dockerfile-nuxt .

vagrant@swarm-manager:~/todonginx$ docker image ls
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
boolks/nginx-nuxt   latest              aa08069b7fea        5 seconds ago       156MB
boolks/todoweb      latest              4a497aa82a24        8 minutes ago       855MB
boolks/nginx        latest              2423c3857b86        16 minutes ago      156MB
boolks/todoapi      latest              16c8340feeab        29 minutes ago      829MB
boolks/tododb       latest              687665459d7a        4 hours ago         491MB

```

##### push

```
vagrant@swarm-manager:~/todonginx$ docker image push boolks/nginx-nuxt:latest

vagrant@swarm-manager:~/todonginx$ cd ~/stack
vagrant@swarm-manager:~/stack$ vi todo-frontend.yml
version: "3"
services:
  nginx:
    image: boolks/nginx-nuxt:latest
    deploy:
      replicas: 2
      placement:
        constraints: [node.role != manager]
    depends_on:
      - web
    environment:
      WORKER_PROCESSES: 2
      WORKER_CONNECTIONS: 1024
      KEEPALIVE_TIMEOUT: 65
      GZIP: "on"
      BACKEND_HOST: todo_frontend_web:3000
      BACKEND_MAX_FAILES: 3
      BACKEND_FAIL_TIMEOUT: 10s
      SERVER_PORT: 80
      SERVER_NAME: localhost
      LOG_STDOUT: "true"
      SERVICE_PORTS: 80
    networks:
      - todoapp
    volumes:
      - assets:/var/www/_nuxt
  web:
    image: boolks/todoweb:latest
    deploy:
      replicas: 1
      placement:
        constraints: [node.role != manager]
    environment:
      TODO_API_URL: http://todo_app_nginx
    networks:
      - todoapp
    volumes:
      - assets:/todoweb/.nuxt/dist
networks:
  todoapp:
    external: true

volumes:
  assets:
    driver: local

vagrant@swarm-manager:~/stack$ docker stack deploy -c ./todo-frontend.yml todo_frontend
Creating service todo_frontend_web
Creating service todo_frontend_nginx

vagrant@swarm-manager:~/stack$ docker service ls
ID                  NAME                  MODE                REPLICAS            IMAGE                      PORTS
sauiwk0wurru        todo_app_api          replicated          2/2                 boolks/todoapi:latest
hgn36v4rkvxf        todo_app_nginx        replicated          2/2                 boolks/nginx:latest
q9cwwir8fkcr        todo_frontend_nginx   replicated          1/2                 boolks/nginx-nuxt:latest
vzrcgp8la4q0        todo_frontend_web     replicated          1/1                 boolks/todoweb:latest
kj3nf863m3x4        todo_mysql_master     replicated          1/1                 boolks/tododb:latest
b42zkw24g0io        todo_mysql_slave      replicated          2/2                 boolks/tododb:latest

```

### **인그레스로 서비스 노출하기**

```
vagrant@swarm-manager:~/stack$ vi todo-ingress.yml

version: "3"
services:
  haproxy:
    image: dockercloud/haproxy
    networks:
      - todoapp
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    deploy:
      mode: global
      placement:
        constraints:
          - node.role == manager
    ports:
      - 80:80
      - 1936:1936

networks:
  todoapp:
    external: true

vagrant@swarm-manager:~/stack$ docker stack deploy -c ./todo-ingress.yml todo_ingress
Creating service todo_ingress_haproxy

vagrant@swarm-manager:~/stack$ docker service ls
ID                  NAME                   MODE                REPLICAS            IMAGE                        PORTS
sauiwk0wurru        todo_app_api           replicated          2/2                 boolks/todoapi:latest
hgn36v4rkvxf        todo_app_nginx         replicated          2/2                 boolks/nginx:latest
q9cwwir8fkcr        todo_frontend_nginx    replicated          2/2                 boolks/nginx-nuxt:latest
vzrcgp8la4q0        todo_frontend_web      replicated          1/1                 boolks/todoweb:latest
j9rzx20v0e0t        todo_ingress_haproxy   global              1/1                 dockercloud/haproxy:latest   *:80->80/tcp, *:1936->1936/tcp
kj3nf863m3x4        todo_mysql_master      replicated          1/1                 boolks/tododb:latest
b42zkw24g0io        todo_mysql_slave       replicated          2/2                 boolks/tododb:latest



http://192.168.111.100/
http://192.168.111.101/
http://192.168.111.102/

```



